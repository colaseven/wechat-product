<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>委托报告</title>
    <link rel="stylesheet" href="../css/framework7.ios.min.css">
    <link rel="stylesheet" href="../css/framework7.ios.colors.min.css">
    <link rel="stylesheet" href="../css/weui/weui.css">
    <link rel="stylesheet" href="../css/main.css">
    <link href="https://cdn.bootcss.com/webuploader/0.1.1/webuploader.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/my-app.css">
    <style>
        .item-input input {
            text-align: right;
        }

        .list-block .areas {
            border: solid 1px #c8c7cc;
            appearance: none;
            -moz-appearance: none;
            -webkit-appearance: none;
            background: url("../images/arrow.png") no-repeat scroll right center transparent;
            font-size: 0.9rem;
            padding: 0.5em 0.8em;
            border-radius: 6px;
            height: auto;
        }

        .item-title, .list-block input[type=text], .list-block input[type=number], .list-block textarea {
            color: #010101;
            font-size: 0.9rem;
        }

        .item-input select, .list-block input[type=tel] {
            color: #010101;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="views">
    <div class="view view-main">
        <div class="pages">
            <div data-page="entrustService" class="page no-navbar no-toolbar">
                <div class="page-content" style="overflow: scroll;">
                    <form id="my-form" class="list-block" style="margin:0;">
                        <div class="errorHint"></div>
                        <button type="reset" style="display:none"></button>
                        <input type="hidden" name="propertyType">
                        <input type="hidden" name="productId">
                        <input type="hidden" name="id">
                        <input type="hidden" name="entrustType" value="10466">
                        <input type="hidden" name="timePoint" id="calendar">
                        <ul>
                            <li class="row" style="text-align: center;padding: 5px 15px;margin:5px 0;border-bottom:1px solid #c8c7cc">
                                <div class="col-30 pull-left">
                                    <div class="item-input" style="margin:0">
                                        <select id="province" name="province" class="areas">
                                            <option value="0">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-30 pull-left">
                                    <div class="item-input" style="margin:0">
                                        <select id="city" name="city" class="areas">
                                            <option value="0">请选择</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-30 pull-left">
                                    <div class="item-input" style="margin:0">
                                        <select id="country" name="county" class="areas">
                                            <option value="0">请选择</option>
                                        </select>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label  searchRequired" style="color:#ff3b30">项目地址</div>
                                        <div class="item-input">
                                            <input type="text" name="detailAddress" placeholder="请输入项目地址">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label searchRequired" style="color:#ff3b30">建筑面积</div>
                                        <div class="item-input">
                                            <input type="number" name="floorAcreage" placeholder="请输入建筑面积">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label  searchRequired" style="color:#ff3b30">报告快递地址</div>
                                        <div class="item-input">
                                            <input type="text" name="reportexpressAddress" placeholder="请输入报告快递地址">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label searchRequired" style="color:#ff3b30">委托人姓名</div>
                                        <div class="item-input">
                                            <input type="text" name="entrustLinkman" placeholder="请输入委托人姓名">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label searchRequired" style="color:#ff3b30">委托电话</div>
                                        <div class="item-input">
                                            <input type="number" name="entrustMobilePhone" placeholder="请输入委托电话">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label searchRequired" style="color:#ff3b30;">短信验证码</div>
                                        <div class="item-input">
                                            <input type="number" name="verificationCode" placeholder="请输入验证码">
                                        </div>
                                    </div>
                                    <div class="sns-btn" id="snsBtn" style="border-bottom: 1px solid #E5E5E5;">获取验证码</div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label">产权人</div>
                                        <div class="item-input">
                                            <input type="text" name="obligeeUserName" placeholder="请输入产权人">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label">土地面积</div>
                                        <div class="item-input">
                                            <input type="number" name="landAcreage" placeholder="请输入土地面积" value="">
                                        </div>
                                    </div>
                                </div>
                            </li>
                            <li>
                                <div class="item-content">
                                    <div class="item-inner">
                                        <div class="item-title label">估价目的</div>
                                        <div class="item-input">
                                            <select id="appraisalObjective" dir="rtl" name="appraisalObjective" class="areas" style="border:none;">
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </li>
                        </ul>
                        <ul>
                            <li class="accordion-item"><a href="javascript:void (0);" class="item-content item-link" id="ctrlBase">
                                <div class="item-inner">
                                    <div class="item-title">上传附件</div>
                                </div>
                            </a>
                                <div class="" style="display: none;" id="baseTab">
                                    <ul>
                                        <li>
                                            <div class="item-content">
                                                <div class="item-inner">
                                                    <div class="item-title label">图片类型</div>
                                                    <div class="item-input">
                                                        <select id="pictureTypes" class="areas" dir="rtl" style="border:none;">
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="item-content">
                                                <div class="common_line publish_images" style="width:100%;margin:0">
                                                    <div class="publish_image_upload" id="filePicker">+</div>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                </div>
                            </li>
                        </ul>
                        <div class="content-block">
                            <p><a href="#" class="btn_primary" id="submitEntrust">提交</a></p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="../js/framework7.js"></script>
<script type="text/javascript" src="../js/jquery.js"></script>
<script type="text/javascript" src="../js/store.min.js"></script>
<script src="http://cdn.staticfile.org/webuploader/0.1.0/webuploader.html5only.min.js"></script>
<script>
    var myApp = new Framework7({
        onAjaxStart: function () {
            myApp.showIndicator();
        },
        onAjaxComplete: function () {
            myApp.hideIndicator();
        },
        modalCloseByOutside: true,
        actionsCloseByOutside: false,
        popupCloseByOutside: false,
        modalTitle: '提示',
        init: false
    });
    var $$ = Dom7;
    var pictureType = '', imgs = [], urlParam = $$.parseQuery(document.url), deftProvince = '', deftCity = '', deftCountry = '', appraisalObjective = '';
    myApp.addView('.view-main', {
        dynamicNavbar: true,
        domCache: true
    });

    var returnData = {};
    myApp.onPageInit('entrustService', function () {
        getAppraisalObjective();
        $('#ctrlBase').click(function () {
            $('#baseTab').slideToggle();
            uploader();
        });
        $$('[type="reset"]').click();
        /*初始化*/
        $$('[name="propertyType"]').val(urlParam.propertyId);
        $$('[name="productId"]').val(urlParam.productId);
        $$('[name="province"]').val(urlParam.province);
        $$('[name="city"]').val(urlParam.city);

        if (urlParam.province !== undefined) {
            deftCity = urlParam.city;
            deftProvince = urlParam.province;
        }

        $('[name="floorAcreage"]').change(function () {
            if ($$('[name="floorAcreage"]').val() <= 0) {
                $$('[name="floorAcreage"]').val('');
            }
        });
        $('[name="landAcreage"]').change(function () {
            if ($$('[name="landAcreage"]').val() <= 0) {
                $$('[name="landAcreage"]').val('');
            }
        });

        var time = 60;
        var myreg = /^[1][3,4,5,7,8][0-9]{9}$/;
        $$('#snsBtn').click(function () {
            var phoneNumber = $$('[name="entrustMobilePhone"]').val();
            if (phoneNumber === '') {
                hintMessage("请先输入手机号码");
                return;
            } else if (!myreg.test(phoneNumber)) {
                return;
            }
            $$.ajax({
                url: '/product/sendSMS.do',
                method: 'get',
                data: {
                    phoneNumber: phoneNumber
                }
            });
            timeWait(this);
        });
        function timeWait(obj) {
            if (time === 0) {
                $(obj).attr('disabled', false);
                $(obj).text('获取验证码');
                time = 60;
            } else {
                $(obj).attr('disabled', true);
                $(obj).text(time + " 秒");
                time--;
                setTimeout(function () {
                    timeWait(obj);
                }, 1000)
            }
        }

        $('[name="entrustMobilePhone"]').change(function () {
            if (!myreg.test($$('[name="entrustMobilePhone"]').val())) {
                $$('[name="entrustMobilePhone"]').val('');
                hintMessage("手机号码格式错误");
            }
        });

        if (urlParam.id) {
            $$.ajax({
                url: '/entrust/particulars.do',
                dataType: 'json',
                method: 'get',
                data: {
                    entrustId: $$.parseQuery(document.url).id
                },
                beforeSend: function () {
                    myApp.showIndicator();
                },
                complete: function () {
                    myApp.hideIndicator();
                },
                success: function (data) {
                    returnData = data;
                    deftProvince = returnData.province;
                    deftCity = returnData.city;
                    deftCountry = returnData.county;
                    $$('[name="entrustLinkman"]').val(returnData.entrustLinkman);
                    $$('[name="entrustMobilePhone"]').val(returnData.entrustMobilePhone);
                    $$('[name="detailAddress"]').val(returnData.detailAddress);
                    $$('[name="floorAcreage"]').val(returnData.floorAcreage);
                    $$('[name="reportexpressAddress"]').val(returnData.reportexpressAddress);
                    $$('[name="obligeeUserName"]').val(returnData.obligeeUserName);
                    $$('[name="landAcreage"]').val(returnData.landAcreage);
                    $$('[name="id"]').val(urlParam.id);
                    appraisalObjective = returnData.appraisalObjective;
                    getAppraisalObjective();
                    getArea('province', '', deftProvince, '0');
                }
            })
        } else if (urlParam.isShift === '0') {//转快捷回价
            deftProvince = store.get('dataParam').provinceCode;
            deftCity = store.get('dataParam').cityCode;
            deftCountry = store.get('dataParam').countyCode;
            getArea('province', '', deftProvince, '0');
            $$('[name="detailAddress"]').val(store.get('detailParam').detailAddress);
            $$('[name="floorAcreage"]').val(store.get('detailParam').structureArea);
        } else {
            getArea('province', '', deftProvince, '0');
        }
        createCalendar();
        getPictureList();
    });
    function getArea(ele, id, defaultCode) {
        $$.ajax({
            url: '/entrust/allAreas.do',
            dataType: 'json',
            method: 'get',
            data: {
                id: id
            },
            beforeSend: function () {
                myApp.showIndicator();
            },
            complete: function () {
                myApp.hideIndicator();
            },
            success: function (data) {
                var html = '<option value="0">请选择</option>';
                if (data !== '') {
                    $$.each(data, function (index, val) {
                        var sel = val.id === defaultCode ? 'selected' : '';
                        html += '<option value="' + val.id + '" ' + sel + '>' + val.text + '</option>';
                    })
                }
                $$('#' + ele).html(html);
                if (deftCity !== '' && ele === 'province' && $('#province option:selected').val() !== '0') {
                    getArea('city', $('#province option:selected').val(), deftCity);
                }
                if (ele === 'city' && $('#city option:selected').val() !== '0') {
                    getArea('country', $('#city option:selected').val(), deftCountry);
                }
            }
        })
    }
    $$('#province').change(function (e) {
        $$('#city').html('<option value="0">请选择</option>');
        $$('#country').html('<option value="0">请选择</option>');
        var selected = e.target.value;
        getArea('city', selected, '');
    });
    $$('#city').change(function (e) {
        $$('#country').html('<option value="0">请选择</option>');
        var selected = e.target.value;
        getArea('country', selected, '');
    });
    /*修改图片类型*/
    $$('#pictureTypes').change(function (e) {
        pictureType = e.target.value;
        $$('.imgCtr').hide();
        $$('#' + pictureType).show();
    });

    //估价目的字典获取
    function getAppraisalObjective() {
        $$.ajax({
            url: '/entrust/dict.do',
            dataType: 'json',
            method: 'get',
            data: {dictType: 'Purpose'},
            beforeSend: function () {
                myApp.showIndicator();
            },
            complete: function () {
                myApp.hideIndicator();
            },
            success: function (data) {
                var listHtml = '<option value="0">请选择</option>';
                var sel;
                $$.each(data, function (index, val) {
                    sel = val.id === appraisalObjective ? 'selected' : '';
                    listHtml += '<option value="' + val.id + '"  ' + sel + '>' + val.text + '</option>';
                });
                $$('#appraisalObjective').html(listHtml);
            }, error: function () {
                window.location.href = "/view/error.html";
            }
        })
    }

    function createCalendar() {
        myApp.calendar({
            input: '#calendar',
            monthNames: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            monthNamesShort: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
            dayNames: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'],
            dayNamesShort: ['日', '一', '二', '三', '四', '五', '六'],
            value: [new Date()],
            closeOnSelect: true
        });
    }
    //获取图片类型
    function getPictureList() {
        $$.ajax({
            url: '/quick/getAttachmentTypes.do',
            dataType: 'json',
            method: 'post',
            data: {},
            beforeSend: function () {
                myApp.showIndicator();
            },
            complete: function () {
                myApp.hideIndicator();
            },
            success: function (data) {
                var picHtml = '', inx = 0, container = '';
                $$.each(data, function (index, val) {
                    if (val.isCurrent === true) {
                        inx = index;
                    }
                    picHtml += '<option value="' + val.value + '">' + val.text + '</option>';
                    container += '<div class="imgCtr" id="' + val.value + '" style="display:none;"></div>';
                });
                $$('#pictureTypes').html(picHtml).find('option').eq(inx).prop('selected', true);
                pictureType = $$('#pictureTypes').find('option').eq(inx).val();
                $$('.publish_images').prepend(container);
                $$('#' + pictureType).show();
            }
        })
    }
    /*删除图片*/
    function uploadedRemove(e) {
        var ele = $$(e).parent();
        ele.remove();
        $$.each(imgs, function (index, data) {
            if (data.id === $$(e).attr('data-id')) {
                imgs.splice(index, 1);
            }
        })
    }
    /*上传图片*/
    function uploader() {
        var uploader = WebUploader.create({
            auto: true,
            // 文件接收服务端。
            server: '/quick/fileUpload.do',
            pick: '#filePicker',
            fileNumLimit: 10,
            chunked: true,
            accept: {
                title: 'Images',
                extensions: 'jpg,jpeg,bmp,png',
                mimeTypes: 'image/*'
            },
            formData: {
                pictureType: ''
            }
        });
        uploader.on('uploadStart', function (file) {
            file.save_key = pictureType;
            uploader.option('formData', {
                pictureType: file.save_key
            });
        });
        uploader.on('uploadSuccess', function (file, response) {
            var imgList = '<div class="publish_image_item pull-left"><span class="iconfont" data-id="' + file.id + '" onclick="uploadedRemove(this)">&#xe69a;</span></aside><img src="' + response.filePath + '"></div>';
            $$('#' + pictureType).append(imgList);
            imgs.push({
                name: file.name,
                type: file.save_key,
                id: file.id,
                url: response.filePath
            })
        });
        uploader.on('uploadError', function (file) {
            myApp.alert(file.name + '上传失败');
        })
    }
    /*提交表单*/
    $$('#submitEntrust').click(function () {
        if (urlParam.isAgainAssess === '1') {//判断是否重新委托
            $$('[name="id"]').val('');
        }
        var formData = myApp.formToJSON('#my-form');
        formData.imgs = imgs;
        if (formData.county === '0') {
            hintMessage("请填写完整的省市区");
            return;
        }
        if (formData.entrustLinkman === '') {
            hintMessage("委托人姓名为必填项");
            return;
        }
        if (formData.detailAddress === '') {
            hintMessage("项目地址为必填项");
            return;
        }
        if (formData.floorAcreage === '') {
            hintMessage("建筑面积为必填项");
            return;
        }
        if (formData.reportexpressAddress === '') {
            hintMessage("报告快递地址为必填项");
            return;
        }
        if (formData.entrustMobilePhone === '') {
            hintMessage("委托电话为必填项");
            return;
        }
        if (formData.verificationCode === '') {
            hintMessage("短信验证码为必填项");
            return;
        }
        param = JSON.stringify(formData);
        $$.ajax({
            url: '/quick/save.do',
            dataType: 'json',
            method: 'post',
            data: {
                model: param,
                type : "entrust"
            },
            beforeSend: function () {
                myApp.showIndicator();
            },
            complete: function () {
                myApp.hideIndicator();
            },
            success: function (data) {
                if (data.state === 2) {
                    window.location.href = "/view/entrustSuccess.html";
                } else {
                    myApp.alert(data.message);
                }
            }
        })
    });


    /**
     * 必填项及错误信息提示
     * @param text
     */
    function hintMessage(text) {
        var errorHint = $$('.errorHint');
        errorHint.css('display', 'block');
        errorHint.text(text);
        setTimeout(function () {
            errorHint.css('display', 'none');
        }, 2000);
    }
    myApp.init();
</script>
</body>
</html>